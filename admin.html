<!DOCTYPE html>
<html>
<head>
    <title>EFC Championship - Admin</title>
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="styles/news-styles.css">
    <link rel="stylesheet" href="styles/race-calendar.css">
    <link rel="stylesheet" href="styles/circuit-maps.css">
    <link rel="stylesheet" href="styles/combined-calendar.css">
    <link rel="stylesheet" href="styles/admin-tools.css">
    
    <!-- Load ALL the same scripts as main page -->
    <script src="scripts/position-tracking.js"></script>
    <script src="scripts/script.js"></script>
    <script src="scripts/news-script.js"></script>
    <script src="scripts/data-manager.js"></script>
    <script src="scripts/race-calendar.js"></script>
    <script src="scripts/circuit-maps.js"></script>
    <script src="scripts/admin-tools.js"></script>
    
    <style>
        /* Admin Login Modal Styles */
        .admin-login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .admin-login-content {
            background: #2a2a2a;
            padding: 40px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
            border: 2px solid #024cad;
            text-align: center;
        }

        .admin-login-content h2 {
            margin: 0 0 20px 0;
            color: #fff;
        }

        .admin-login-content p {
            color: #ccc;
            margin-bottom: 25px;
        }

        .admin-login-input {
            width: 100%;
            padding: 15px;
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            margin-bottom: 20px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .admin-login-input:focus {
            outline: none;
            border-color: #024cad;
        }

        .admin-login-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-login-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .admin-login-buttons button:first-child {
            background: #024cad;
            color: white;
        }

        .admin-login-buttons button:first-child:hover {
            background: #036ee0;
        }

        .admin-login-buttons button:last-child {
            background: #666;
            color: white;
        }

        .admin-login-buttons button:last-child:hover {
            background: #888;
        }

        .admin-login-hint {
            margin-top: 15px;
            color: #888;
            font-size: 12px;
        }

        /* Poll Management Styles */
        .poll-tab-content {
            display: none;
        }

        .poll-tab-content.active {
            display: block;
        }

        .poll-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .remove-option-btn {
            background: #dc0000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-option-btn:hover {
            background: #b30000;
        }
    </style>
</head>
<body>
    <div class="f1-container">
        <div class="header">
            <img src="https://i.postimg.cc/SQ34Kccv/EFC.png" alt="EFC Logo" class="header-logo" onerror="this.style.display='none'">
            <h1>‚öôÔ∏è EFC Championship Admin</h1>
            <button class="refresh-button" onclick="goToMainPage()">‚Üê Back to Main</button>
        </div>

        <div class="admin-main-content">
            <div class="admin-welcome">
                <h2>Administration Dashboard</h2>
                <p>Manage your EFC Championship data and settings</p>
            </div>

            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="quick-actions">Quick Actions</button>
                <button class="admin-tab" data-tab="data-management">Data Management</button>
                <button class="admin-tab" data-tab="circuit-editor">Circuit Management</button>
                <button class="admin-tab" data-tab="poll-management">Poll Management</button>
                <button class="admin-tab" data-tab="system-tools">System Tools</button>
            </div>

            <div class="admin-content">
                <div id="quick-actions-tab" class="admin-tab-content active">
                    <div class="admin-section">
                        <h3>Race Management</h3>
                        <div class="action-grid">
                            <button onclick="adminTools.addTestRace()" class="admin-btn large">
                                <span class="admin-btn-icon">üèÅ</span>
                                <span class="admin-btn-text">Add Test Race</span>
                            </button>
                            <button onclick="adminTools.simulateRace()" class="admin-btn large">
                                <span class="admin-btn-icon">üéÆ</span>
                                <span class="admin-btn-text">Simulate Race Results</span>
                            </button>
                            <button onclick="adminTools.updateCalendar()" class="admin-btn large">
                                <span class="admin-btn-icon">üìÖ</span>
                                <span class="admin-btn-text">Update Race Calendar</span>
                            </button>
                            <button onclick="adminTools.setRaceDate()" class="admin-btn large">
                                <span class="admin-btn-icon">üìÖ</span>
                                <span class="admin-btn-text">Set Race Dates</span>
                            </button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>Driver Management</h3>
                        <div class="action-grid">
                            <button onclick="adminTools.addDriver()" class="admin-btn large">
                                <span class="admin-btn-icon">üë§</span>
                                <span class="admin-btn-text">Add New Driver</span>
                            </button>
                            <button onclick="adminTools.updateStandings()" class="admin-btn large">
                                <span class="admin-btn-icon">üìä</span>
                                <span class="admin-btn-text">Update Standings</span>
                            </button>
                            <button onclick="adminTools.recalculateRatings()" class="admin-btn large">
                                <span class="admin-btn-icon">‚≠ê</span>
                                <span class="admin-btn-text">Recalculate Ratings</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="data-management-tab" class="admin-tab-content">
                    <div class="admin-section">
                        <h3>Import & Export Data</h3>
                        <div class="action-grid">
                            <button onclick="adminTools.exportCircuitData()" class="admin-btn large">
                                <span class="admin-btn-icon">üì§</span>
                                <span class="admin-btn-text">Export Circuit Data</span>
                            </button>
                            <button onclick="adminTools.importCircuitData()" class="admin-btn large">
                                <span class="admin-btn-icon">üì•</span>
                                <span class="admin-btn-text">Import Circuit Data</span>
                            </button>
                            <button onclick="adminTools.backupSheets()" class="admin-btn large">
                                <span class="admin-btn-icon">üíæ</span>
                                <span class="admin-btn-text">Backup Google Sheets</span>
                            </button>

                            <button onclick="exportDataForSheets()" class="admin-export-btn">
                                üì§ Export ALL Data to Google Sheets
                            </button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>Manual Data Entry</h3>
                        <div class="manual-entry">
                            <textarea id="manual-data-input" placeholder='Paste JSON circuit data here...'></textarea>
                            <div class="manual-entry-buttons">
                                <button onclick="adminTools.processManualData()" class="admin-btn">Process Data</button>
                                <button onclick="adminTools.validateData()" class="admin-btn">Validate Format</button>
                                <button onclick="adminTools.clearManualData()" class="admin-btn warning">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="circuit-editor-tab" class="admin-tab-content">
                    <div class="admin-section">
                        <h3>Circuit Management</h3>
                        <div class="circuit-actions">
                            <button onclick="adminTools.updateCalendar()" class="admin-btn">üîÑ Refresh from Race Results</button>
                            <button onclick="adminTools.exportCircuitData()" class="admin-btn">üì§ Export Circuit Data</button>
                            <button onclick="adminTools.importCircuitData()" class="admin-btn">üì• Import Circuit Data</button>
                            <button onclick="adminTools.clearCache()" class="admin-btn warning">üóëÔ∏è Clear Circuit Cache</button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>Current Circuits</h3>
                        <div class="circuit-list-header">
                            <p>Manage circuit information for each race in the calendar. Click "Add/Edit Circuit Info" to configure each circuit.</p>
                        </div>
                        <div id="circuit-list" class="circuit-list">
                            <div class="loading">Loading circuits...</div>
                        </div>
                    </div>
                </div>

                <div id="poll-management-tab" class="admin-tab-content">
                    <div class="admin-section">
                        <h3>Poll Management</h3>
                        <div class="action-grid">
                            <button onclick="adminTools.managePolls()" class="admin-btn large">
                                <span class="admin-btn-icon">üìä</span>
                                <span class="admin-btn-text">Manage Polls</span>
                            </button>
                            <button onclick="adminTools.createSamplePolls()" class="admin-btn large">
                                <span class="admin-btn-icon">üîÑ</span>
                                <span class="admin-btn-text">Create Sample Polls</span>
                            </button>
                            <button onclick="adminTools.clearAllPolls()" class="admin-btn large warning">
                                <span class="admin-btn-icon">üóëÔ∏è</span>
                                <span class="admin-btn-text">Clear All Polls</span>
                            </button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>Poll Statistics</h3>
                        <div class="debug-info">
                            <div class="debug-item">
                                <label>Total Polls:</label>
                                <span id="total-polls">0</span>
                            </div>
                            <div class="debug-item">
                                <label>Live Polls:</label>
                                <span id="live-polls">0</span>
                            </div>
                            <div class="debug-item">
                                <label>Total Votes:</label>
                                <span id="total-votes">0</span>
                            </div>
                            <button onclick="adminTools.updatePollStats()" class="admin-btn">Refresh Stats</button>
                        </div>
                    </div>
                </div>

                <div id="system-tools-tab" class="admin-tab-content">
                    <div class="admin-section">
                        <h3>System Maintenance</h3>
                        <div class="action-grid">
                            <button onclick="adminTools.clearCache()" class="admin-btn large warning">
                                <span class="admin-btn-icon">üóëÔ∏è</span>
                                <span class="admin-btn-text">Clear Cache</span>
                            </button>
                            <button onclick="adminTools.reloadAllData()" class="admin-btn large">
                                <span class="admin-btn-icon">üîÑ</span>
                                <span class="admin-btn-text">Reload All Data</span>
                            </button>
                            <button onclick="adminTools.forceRecalculate()" class="admin-btn large">
                                <span class="admin-btn-icon">üßÆ</span>
                                <span class="admin-btn-text">Recalculate Standings</span>
                            </button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>Debug Information</h3>
                        <div class="debug-info">
                            <div class="debug-item">
                                <label>Last Data Refresh:</label>
                                <span id="last-refresh">Never</span>
                            </div>
                            <div class="debug-item">
                                <label>Cache Size:</label>
                                <span id="cache-size">0 KB</span>
                            </div>
                            <div class="debug-item">
                                <label>Admin Session:</label>
                                <span id="admin-session">Active</span>
                            </div>
                            <button onclick="adminTools.showDebugInfo()" class="admin-btn">Show Detailed Debug</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-footer">
    <div class="admin-status" id="admin-status">
        <span class="status-indicator"></span>
        Admin session active
    </div>
    <div class="admin-footer-buttons">
        <button onclick="adminTools.goToMainPage()" class="admin-mainpage-btn">üè† Back to Main Page</button>
        <button onclick="adminTools.logout()" class="admin-logout-btn">Logout</button>
    </div>
</div>

    <script>
        // Check if user is logged in as admin
            if (!localStorage.getItem('efc_admin')) {
    // If not admin, redirect back to main page
    window.location.href = 'index.html';
}
        // ENHANCED ADMIN INITIALIZATION WITH MAIN PAGE DATA
        console.log('=== ADMIN PAGE LOADING WITH MAIN PAGE SCRIPTS ===');
        
        function goToMainPage() {
            window.location.href = 'index.html';
        }

        // Force admin status
        localStorage.setItem('efc_admin', 'true');

        // Enhanced initialization that waits for all main page scripts
        async function initializeAdminWithMainData() {
            console.log('Initializing admin with main page data...');
            
            // Wait for all main page scripts to load
            if (typeof adminTools === 'undefined' || typeof RaceCalendar === 'undefined') {
                console.log('Waiting for main page scripts to load...');
                setTimeout(initializeAdminWithMainData, 100);
                return;
            }

            console.log('All main page scripts loaded!');
            
            // Initialize race calendar with main page data
            if (!window.raceCalendar) {
                console.log('Creating new race calendar instance...');
                window.raceCalendar = new RaceCalendar();
                await window.raceCalendar.init();
                console.log('Race calendar initialized with', window.raceCalendar.races.length, 'races');
            } else {
                console.log('Race calendar already exists with', window.raceCalendar.races.length, 'races');
            }

            // Initialize admin tools
            adminTools.initializeAdminPage();
            console.log('‚úÖ Admin page fully initialized with main page data');
        }

        // Start initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting admin with main data...');
            setTimeout(initializeAdminWithMainData, 500);
        });

        // Also initialize when window loads
        window.addEventListener('load', function() {
            console.log('Window fully loaded');
            // If not initialized yet, try again
            if (!window.adminTools || !window.adminTools.initialized) {
                setTimeout(initializeAdminWithMainData, 300);
            }
        });

        // Global function for login button
        window.handleAdminLogin = function() {
            localStorage.setItem('efc_admin', 'true');
            window.location.reload();
        }

        // Add missing poll management methods to adminTools
        window.adminTools.createSamplePolls = function() {
            const samplePolls = [
                {
                    id: Date.now(),
                    question: "Who will win the EFC Championship this season?",
                    options: [
                        { text: "Max Verstappen", votes: 45, percentage: 45 },
                        { text: "Lewis Hamilton", votes: 30, percentage: 30 },
                        { text: "Charles Leclerc", votes: 15, percentage: 15 },
                        { text: "Lando Norris", votes: 10, percentage: 10 }
                    ],
                    totalVotes: 100,
                    status: "live",
                    endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    userVoted: false,
                    userSelection: null
                },
                {
                    id: Date.now() + 1,
                    question: "Which team has the best livery this season?",
                    options: [
                        { text: "Mercedes", votes: 25, percentage: 25 },
                        { text: "Ferrari", votes: 35, percentage: 35 },
                        { text: "Red Bull", votes: 20, percentage: 20 },
                        { text: "McLaren", votes: 20, percentage: 20 }
                    ],
                    totalVotes: 100,
                    status: "live",
                    endDate: new Date(Date.now() + 45 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    userVoted: false,
                    userSelection: null
                }
            ];
            
            localStorage.setItem('efc_polls', JSON.stringify(samplePolls));
            this.showNotification('Sample polls created successfully!', 'success');
            
            // Update stats
            this.updatePollStats();
        };

        window.adminTools.clearAllPolls = function() {
            if (!confirm('Are you sure you want to delete ALL polls? This cannot be undone.')) {
                return;
            }
            
            localStorage.removeItem('efc_polls');
            localStorage.removeItem('efc_poll_votes');
            this.showNotification('All polls cleared successfully!', 'success');
            
            // Update stats
            this.updatePollStats();
        };

        window.adminTools.updatePollStats = function() {
            const polls = JSON.parse(localStorage.getItem('efc_polls') || '[]');
            const totalPolls = polls.length;
            const livePolls = polls.filter(poll => poll.status === 'live').length;
            const totalVotes = polls.reduce((sum, poll) => sum + poll.totalVotes, 0);
            
            document.getElementById('total-polls').textContent = totalPolls;
            document.getElementById('live-polls').textContent = livePolls;
            document.getElementById('total-votes').textContent = totalVotes;
        };

        // Initialize poll stats on load
        setTimeout(() => {
            if (window.adminTools && window.adminTools.updatePollStats) {
                window.adminTools.updatePollStats();
            }
        }, 1000);
    </script>
</body>
</html>